# API Log Iceberg Integration Test
# ================================
# Tests the native Iceberg API log writer (no Kafka required).
#
# Architecture:
#   MinIO Cluster (4 nodes) -> Internal API Logs -> Iceberg Table
#                                                       |
#                                                       v
#                                                    Trino (query)
#
# The MinIO cluster writes API logs directly to an Iceberg table using:
#   - MINIO_LOG_API_INTERNAL_ENABLE: enables internal API log storage
#   - MINIO_LOG_API_INTERNAL_ICEBERG_ENABLE: enables Iceberg table format
#   - MINIO_LOG_API_INTERNAL_ICEBERG_BUCKET: target bucket (must be a warehouse)
#
# Configuration: Copy .env.sample to .env and configure your settings

x-minio-common: &minio-common
  image: ${MINIO_IMAGE:-minio/minio:latest}
  pull_policy: if_not_present
  command: server --console-address ":9001" http://minio{1...4}/data{1...2}
  expose:
    - "9000"
    - "9001"
  environment:
    MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minioadmin}
    MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minioadmin}
    MINIO_LICENSE: ${MINIO_LICENSE}
    # Internal API Log Storage (required for Iceberg)
    MINIO_LOG_API_INTERNAL_ENABLE: "on"
    MINIO_LOG_API_INTERNAL_DRIVE_LIMIT: ${API_LOG_DRIVE_LIMIT:-1Gi}
    MINIO_LOG_API_INTERNAL_FLUSH_INTERVAL: ${API_LOG_FLUSH_INTERVAL:-1m}
    # Iceberg API Log Configuration
    MINIO_LOG_API_INTERNAL_ICEBERG_ENABLE: "on"
    MINIO_LOG_API_INTERNAL_ICEBERG_BUCKET: ${ICEBERG_BUCKET:-api-logs}
    MINIO_LOG_API_INTERNAL_ICEBERG_PREFIX: ${ICEBERG_PREFIX:-}
    MINIO_LOG_API_INTERNAL_ICEBERG_NAMESPACE: ${ICEBERG_NAMESPACE:-minio}
    MINIO_LOG_API_INTERNAL_ICEBERG_TABLE: ${ICEBERG_TABLE:-api_logs}
    MINIO_LOG_API_INTERNAL_ICEBERG_WRITE_INTERVAL: ${ICEBERG_WRITE_INTERVAL:-30s}
    MINIO_LOG_API_INTERNAL_ICEBERG_COMMIT_INTERVAL: ${ICEBERG_COMMIT_INTERVAL:-1m}
    # Hidden tuning (for testing with smaller batches)
    _MINIO_LOG_API_INTERNAL_ICEBERG_BATCH_SIZE: ${ICEBERG_BATCH_SIZE:-1000}
  healthcheck:
    test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
    interval: 5s
    timeout: 10s
    retries: 5
    start_period: 10s
  networks:
    - api-log-iceberg

services:
  # ============================================================================
  # MinIO Cluster (4 nodes)
  # ============================================================================
  minio1:
    <<: *minio-common
    hostname: minio1
    container_name: minio1
    volumes:
      - minio1-data1:/data1
      - minio1-data2:/data2

  minio2:
    <<: *minio-common
    hostname: minio2
    container_name: minio2
    volumes:
      - minio2-data1:/data1
      - minio2-data2:/data2

  minio3:
    <<: *minio-common
    hostname: minio3
    container_name: minio3
    volumes:
      - minio3-data1:/data1
      - minio3-data2:/data2

  minio4:
    <<: *minio-common
    hostname: minio4
    container_name: minio4
    volumes:
      - minio4-data1:/data1
      - minio4-data2:/data2

  # ============================================================================
  # Nginx Load Balancer
  # ============================================================================
  nginx:
    image: nginx:alpine
    hostname: nginx
    container_name: nginx
    ports:
      - "${API_PORT:-9000}:9000"
      - "${CONSOLE_PORT:-9001}:9001"
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      minio1:
        condition: service_healthy
      minio2:
        condition: service_healthy
      minio3:
        condition: service_healthy
      minio4:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 5s
      timeout: 10s
      retries: 5
      start_period: 10s
    networks:
      - api-log-iceberg

  # ============================================================================
  # Trino Query Engine - For querying Iceberg tables
  # ============================================================================
  trino:
    image: ${TRINO_IMAGE:-trinodb/trino:477}
    hostname: trino
    container_name: trino
    depends_on:
      nginx:
        condition: service_healthy
    environment:
      - CATALOG_MANAGEMENT=dynamic
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/v1/status"]
      interval: 5s
      timeout: 10s
      retries: 5
      start_period: 30s
    ports:
      - "${TRINO_PORT:-9999}:8080"
    networks:
      - api-log-iceberg

  # ============================================================================
  # Init Container - Creates warehouse bucket, generates traffic, sets up Trino
  # ============================================================================
  init:
    image: python:3.11-slim
    container_name: api-log-iceberg-init
    depends_on:
      nginx:
        condition: service_healthy
      trino:
        condition: service_healthy
    volumes:
      - ./init-setup.py:/init-setup.py:ro
    environment:
      MINIO_ENDPOINT: http://nginx:9000
      MINIO_ACCESS_KEY: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_SECRET_KEY: ${MINIO_ROOT_PASSWORD:-minioadmin}
      WAREHOUSE_BUCKET: ${ICEBERG_BUCKET:-api-logs}
      NAMESPACE: ${ICEBERG_NAMESPACE:-minio}
      TABLE_NAME: ${ICEBERG_TABLE:-api_logs}
      TRINO_HOST: trino
      TRINO_PORT: 8080
      # Traffic generation settings
      GENERATE_TRAFFIC: ${GENERATE_TRAFFIC:-true}
      TRAFFIC_BUCKET: ${TRAFFIC_BUCKET:-test-data}
      TRAFFIC_OBJECTS: ${TRAFFIC_OBJECTS:-100}
      TRAFFIC_OBJECT_SIZE: ${TRAFFIC_OBJECT_SIZE:-1024}
      # Wait time for logs to be written to Iceberg
      WAIT_FOR_ICEBERG_SECONDS: ${WAIT_FOR_ICEBERG_SECONDS:-120}
    entrypoint: >
      bash -c "
        pip install -q requests trino &&
        python /init-setup.py
      "
    networks:
      - api-log-iceberg

networks:
  api-log-iceberg:
    driver: bridge

volumes:
  minio1-data1:
  minio1-data2:
  minio2-data1:
  minio2-data2:
  minio3-data1:
  minio3-data2:
  minio4-data1:
  minio4-data2:
